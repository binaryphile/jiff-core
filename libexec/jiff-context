#!/usr/bin/env bash
# Usage: jiff context CONTEXT|none [rhel-6|centos-6|ubuntu-14|ubuntu-15]
# Summary: Add tasks which presume an os distribution, user role and set of available resources

source stdlib
source arraylib

LibExec="${_JIFF_ROOT}/libexec"
DistroLink="${_JIFF_ROOT}/lib/distrolib"
RoleLink="${_JIFF_ROOT}/lib/rolelib"
ContextLink="${_JIFF_ROOT}/context/current"
Distros=( $(available_distros) )
# Contexts=( $(available_contexts) )

main () {
  local context
  local distro

  context="${1:-}"
  distro="${2:-}"
  if is_empty "${context}"; then
    usage
    report_current
    exit 0
  fi
  if match "${context}" "none"; then
    remove_links
    exit 0
  fi
  is_not_empty "${distro}" || distro="$(detect_os)"
  if array_contains "${distro}" "${Distros[@]}"; then
    remove_links
    make_links "${context}" "${distro}"
    exit 0
  fi

  usage
  exit 1
}

available_contexts () {
  # shellcheck disable=SC2010
  ls "${_JIFF_ROOT}/context" | grep -v current
}

available_distros () {
  ls "${_JIFF_ROOT}/distro"
}

make_links () {
  local context
  local distro
  local file
  local link

  context="${1}"
  distro="${2}"
  make_symlink "${ContextLink}" "${context}/${distro}/role"
  make_symlink "${DistroLink}" "../distro/${distro}/distro"
  make_symlink "${RoleLink}" "../distro/${distro}/role"
  for file in ${ContextLink}/jiff-*; do
    match "${file}" "${ContextLink}/jiff-*" && continue
    link="$(base_name "${file}")"
    make_symlink "${LibExec}/${link}" "${file}"
  done
}

remove_links () {
  local file
  local link

  for file in "${ContextLink}"/jiff-*; do
    link="$(base_name "${file}")"
    rm -f "${LibExec}/${link}"
  done
  for link in "${ContextLink}" "${DistroLink}" "${RoleLink}"; do
    rm -f "${link}"
  done
}

report_current () {
  local current

  if is_link "${ContextLink}"; then
    current="$(readlink "${ContextLink}" | cut -d/ -f1)"
  else
    current=none
  fi
  cat <<EOM
Currently using: ${current}
EOM
}

usage () {
# TODO: fill in contexts from $Distros
  cat <<EOM
Usage: jiff context CONTEXT|none [rhel-6|centos-6|ubuntu-14|ubuntu-15]

Available contexts:

$(available_contexts)

EOM
}

return 2>/dev/null || true
strict_mode on
main "${@}"

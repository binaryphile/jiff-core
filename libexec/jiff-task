#!/usr/bin/env bash
# Usage: jiff task add|edit|publish|show taskname
# Summary: Manage jiff tasks

source stdlib

strict_mode on
# trace on # for debugging while developing

# Provide jiff completions
if match "${1:-}" "--complete"; then
  cat <<EOM
add
EOM
  exit 0
fi

EDITOR="${EDITOR:-/usr/bin/vim}"

add_task () {
  local taskname="${1:-}"
  local filename="jiff-${taskname}"
  local task_dir="${_JIFF_ROOT}/libexec"

  if is_empty "${taskname}"; then
    usage
    exit 0
  fi
  ! match "${2:-}" "platform" || task_dir="${_JIFF_ROOT}/libexec/platforms/current"
  push_dir "${task_dir}"
  if is_file "${filename}"; then
    echoerr "Task already exists!"
    exit 1
  fi
  install -m 755 "${_JIFF_ROOT}/share/jiff/jiff-sample-task" "${filename}"
  sed -i -e "s|jiff sample-task|jiff ${taskname}|" "${filename}"
  ! shell_is_bash || ! is_file "${HOME}/.bash_history" || tail -50 "${HOME}/.bash_history" >> "${filename}"
  "${EDITOR}" "${filename}"
  git add "${filename}"
  pop_dir
}

publish_task () {
  local taskname="${1:-}"
  local filename="jiff-${taskname}"
  local task_dir="${_JIFF_ROOT}/libexec"

  if is_empty "${taskname}"; then
    usage
    exit 0
  fi
  ! match "${2:-}" "platform" || task_dir="${_JIFF_ROOT}/libexec/platforms/current"
  push_dir "${task_dir}"
  git add "${filename}"
  git commit --message "automated commit"
  git push
  pop_dir
}

edit_task () {
  local taskname="${1:-}"
  local filename="jiff-${taskname}"
  local task_dir="${_JIFF_ROOT}/libexec"

  if is_empty "${taskname}"; then
    usage
    exit 0
  fi
  ! match "${2:-}" "platform" || task_dir="${_JIFF_ROOT}/libexec/platforms/current"
  push_dir "${task_dir}"
  "${EDITOR}" "${filename}"
  git add "${filename}"
  pop_dir
}

show_task () {
  local taskname="${1:-}"
  local filename="jiff-${taskname}"
  local task_dir="${_JIFF_ROOT}/libexec"

  if is_empty "${taskname}"; then
    usage
    exit 0
  fi
  ! match "${2:-}" "platform" || task_dir="${_JIFF_ROOT}/libexec/platforms/current"
  cat "${task_dir}/${filename}"
}

usage () {
  echo "Usage: jiff task add|edit|publish|show taskname"
}

subtask="${1:-}"
shift

case "${subtask}" in
  "add" )
    add_task "${@}"
    ;;
  "publish" )
    publish_task "${@}"
    ;;
  "edit" )
    edit_task "${@}"
    ;;
  "show" )
    show_task "${@}"
    ;;
  * )
    usage
    ;;
esac

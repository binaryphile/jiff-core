#!/usr/bin/env bash
# Usage: jiff role [admin|user]

source stdlib
source jifflib

RoleLink="${_JIFF_ROOT}/role/current"

main () {
  local dirname
  local role

  role="${1:-}"
  if is_empty "${role}"; then
    usage
    report_current
    exit 0
  fi
  dirname="$(abs_dirname "${_JIFF_ROOT}/context/current")"
  dirname="$(abs_dirname "${dirname}/../")"
  make_symlink "${dirname}/role" "${role}"
  make_rolelinks
}

available_roles () {
  # shellcheck disable=SC2010
  ls "${_JIFF_ROOT}/role" | grep -v current
}

report_current () {
  local current

  if is_link "${RoleLink}"; then
    current="$(readlink "${RoleLink}" | cut -d/ -f1)"
  else
    current=none
  fi
  cat <<EOM
Currently using: ${current}
EOM
}

usage () {
# TODO: fill in roles from $Roles
  cat <<EOM
Usage: jiff role ROLE

Available roles:

$(available_roles)

EOM
}

return 2>/dev/null || true
strict_mode on
main "${@}"
